########################### NETWORKS
networks:
  default:
    driver: bridge
  socket_proxy:
    name: socket_proxy
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.14.0/24
  t3_proxy:
    name: t3_proxy
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.15.0/24
    external: true

services:

############# CORE

  # Docker Socket Proxy - Security Enchanced Proxy for Docker Socket
  socket-proxy:
    container_name: socket_proxy
    image: linuxserver/socket-proxy:3.2.6-r0-ls57@sha256:1be5bc2319d84e94999ad8461aa5864dae245d63247779bbd5630ba7151b30b7
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    profiles: ["core", "all"]
    networks:
      socket_proxy:
        ipv4_address: 192.168.14.254 # You can specify a static IP
    privileged: true # true for VM. False (default) for unprivileged LXC container.
    # ports:
      #- "2375:2375"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    read_only: true
    tmpfs:
      - /run
    environment:
      - LOG_LEVEL=warning # debug,info,notice,warning,err,crit,alert,emerg
      - ALLOW_START=1 # Portainer
      - ALLOW_STOP=1 # Portainer
      - ALLOW_RESTARTS=1 # Portainer
      ## Granted by Default
      - EVENTS=1
      - PING=1
      - VERSION=1
      ## Revoked by Default
      # Security critical
      - AUTH=0
      - SECRETS=0
      - POST=1 # Watchtower
      # Not always needed
      - BUILD=0 - COMMIT=0 - CONFIGS=0 - CONTAINERS=1 # Traefik, portainer, etc. - DISTRIBUTION=0 
      - EXEC=0 - IMAGES=1 # Portainer - INFO=1 # Portainer - NETWORKS=1 # Portainer - NODES=0 - 
      - PLUGINS=0 - SERVICES=1 # Portainer - SESSION=0 - SWARM=0 - SYSTEM=0 - TASKS=1 # Portainer - 
      - VOLUMES=1 # Portainer - DISABLE_IPV6=0 #optional

  agent:
    container_name: portainer_agent
    image: portainer/agent:2.34.0@sha256:ffe66edf605824d0249e19ade394d7b764209b002b60b5cebd959c81c2c6fbb2
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    profiles: ["core", "all"]
    networks:
      - default
      - socket_proxy
#    command: -H unix:///var/run/docker.sock # Use Docker Socket Proxy instead for improved security
 #   command: -H tcp://socket-proxy:2375
    ports:
      - "$PORTAINER_AGENT_PORT:9001"     # Agent API
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro # Use Docker Socket Proxy instead for improved security
      - /var/lib/docker/volumes:/var/lib/docker/volumes
      - /:/host

  dozzle-agent:
    container_name: dozzle_agent
    image: amir20/dozzle:v8.14.4@sha256:e944224b30d0ac8771d7e54c5ae0dfb30859d6b7e590b65e90bafe39c15c46ce
    restart: always
    command: agent
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
      - $DOZZLE_AGENT_PORT:7007


############# UTILITIES

  syncthing:
    container_name: syncthing
    image: linuxserver/syncthing:v2.0.10-ls198@sha256:e5a6e179dab7452cd93768965b5c71a840448e1291b1f781426429bbb0a128c2
    hostname: syncthing #optional
    environment:
      - PUID=$PUID
      - PGID=$PGID
      - TZ=$TZ
    volumes:
      - $DOCKERDIR/appdata/syncthing/config:/config
      - /home/medivh/data/sync:/sync
#      - /path/to/data2:/data2
    ports:
      - $SYNCTHING_PORT:8384
      - 22000:22000/tcp
      - 22000:22000/udp
      - 21027:21027/udp
    restart: unless-stopped
    labels:
      - "traefik.enable=true"

  ###### MEDIA FILE MANAGEMENT

  # Calibre   ^`^s Ebooks and Management (Server)
  calibre:
    container_name: calibre
    image: linuxserver/calibre:v8.12.0-ls362@sha256:4edb4c47f36bc8e520dfaa40548fa94fd67e1686ff667271a04a515710d259a4
    restart: always
    networks:
      - t3_proxy
    ports:
      - $CALIBRE_PORT:8080 # Desktop GUI
     # - $CALIBRE_PORT:8081 # Webserver GUI
    volumes:
      - $DOCKERDIR/appdata/calibre:/config:rw
      - /mnt/media/library:/library:rw
    environment:
      - PUID=$PUID
      - PGID=$PGID
      - TZ=$TZ
#      - GUAC_USER=abc #Gucamole user optional
#      - GUAC_PASS=abc
      # - GUAC_PASS=900150983cd24fb0d6963f7d28e17f72 #Guacamole password optional
#      - UMASK_SET=002 #optional
      # - CLI_ARGS= #optional
    labels:
      - "traefik.enable=true"

#  # Calibre-web Ebooks and Management (Plex of Ebooks)
#  calibre-web:
#    container_name: calibre-web
#    image: linuxserver/calibre-web:0.6.25-ls351@sha256:f3d82c71b8a97c09c182503ac14baa4e547f8dbf6f0a83531d81e779f2f51d64
#    restart: always
#    networks:
#      - t3_proxy
#    ports:
#      - $CALIBRE_WEB_PORT:8083
#    environment:
#      - PUID=$PUID
#      - PGID=$PGID
#      - TZ=$TZ
#      - DOCKER_MODS=ghcr.io/linuxserver/mods:universal-calibre
#     # - DOCKER_MODS=linuxserver/calibre-web:calibre
#    volumes:
#      - $DOCKERDIR/appdata/calibre-web:/config
#      - /home/medivh/data/library/books:/books
#    labels:
#      - "traefik.enable=true"
#    #  ## Kobo
#    #  - "traefik.http.middlewares.kobo-sync-headers.headers.customrequestheaders.X-Scheme=https"
##      - "traefik.http.routers.calibre-web-rtr.middlewares=chain-no-auth@file,kobo-sync-headers" # Google OAuth 2.0

  ## Firefly III
  fireflyiii:
    container_name: fireflyiii
    image: fireflyiii/core:version-6.4.0@sha256:4ec511c1792290421d8d0803c604d2d2a487b7d0b334547d32cfa23097d9e455
    restart: always
    volumes:
      - $DOCKERDIR/appdata/firefly_iii:/var/www/html/storage/upload
      - /etc/timezone:/etc/timezone:ro
    env_file: .env.firefly
    networks:
      - t3_proxy
    ports:
      - $FIREFLY_PORT:8080
    depends_on:
      - mariadb
    labels:
      - "traefik.enable=true"

  ## Firefly III - Importer
  fireflyiii_importer:
    container_name: fireflyiii_importer
    image: fireflyiii/data-importer:version-1.8.2@sha256:e43d8abbb86e09b90f4cd8ecdc3d80024778841bf579969aa219bf942c0ea9cc
    networks:
      - t3_proxy
    restart: always
    ports:
      - $FIREFLY_IMPORTER_PORT:8080
    depends_on:
      - fireflyiii
    env_file: .env.firefly.importer
#    volumes:
#      - $DOCKERDIR/appdata/firefly_iii_importer:/import
    labels:
      - "traefik.enable=true"

  # Calibre-Web-Automated
  calibre-web-automated:
    container_name: calibre-web-automated
    image: ghcr.io/crocodilestick/calibre-web-automated:dev
    restart: always
    networks:
      - t3_proxy
    environment:
      - PUID=$PUID
      - PGID=$PGID
      - TZ=$TZ
      # Hardcover API Key required for Hardcover as a Metadata Provider, get one here: https://docs.hardcover.app/api/getting-started/
      # EXPIRES IN 1 YEAR! 16-10-2025! YA BE WARNED!
      - HARDCOVER_TOKEN=$HARDCOVER_TOKEN
      # If your library is on a network share (e.g., NFS/SMB), disable WAL to reduce locking issues
      # Accepts: true/false (default: false)
      - NETWORK_SHARE_MODE=false
      # Override the default port (8083) for the web server.
      # Accepts any valid port number.
      - CWA_PORT_OVERRIDE=8083
    volumes:
      # CW users migrating should stop their existing CW instance, make a copy of the config folder, and bind that here to carry over all of their user settings ect.
      - $DOCKERDIR/appdata/calibre-web-automated/config:/config 
      # This is an ingest dir, NOT a library one. Anything added here will be automatically added to your library according to the settings you have configured in CWA Settings page. All files placed here are REMOVED AFTER PROCESSING
      - $DATADIR/library/ingest:/cwa-book-ingest
      # If you don't have an existing library, CWA will automatically create one at the bind provided here
      - $DATADIR/library/library:/calibre-library
      # If you use calibre plugins, you can bind your plugins folder here to have CWA attempt to add them to its workflow (WIP)
      # If you are starting with a fresh install, you also need to copy customize.py.json to the Calibre config volume above, in /path/to/config/folder/.config/calibre/customize.py.json, see the note below for more info
      - $DOCKERDIR/appdata/calibre/.config/calibre/plugins:/config/.config/calibre/plugins
    ports:
      # Change the first number to change the port you want to access the Web UI, not the second
      - $CALIBRE_WEB_AUTOMATED_PORT:8083
    # If you set CWA_PORT_OVERRIDE to a port below 1024, you may need to uncomment the following line:
    # cap_add:
    #   - NET_BIND_SERVICE
    labels:
      - "traefik.enable=true"


  ##### DATABASES

  # MariaDB - MySQL Database
  mariadb:
    container_name: mariadb
    image: linuxserver/mariadb:11.4.8@sha256:aab0f8bdcbe5ed275e6682c84f274dccf38094f2dda75d563edfa7b5c85e0fbf
    restart: always 
    networks:
      - t3_proxy
    env_file: .env.firefly.db
    environment:
      - PUID=$PUID
      - PGID=$PGID
      - TZ=$TZ
      - MYSQL_ROOT_PASSWORD=ROOT_ACCESS_PASSWORD
    volumes:
      - $DOCKERDIR/appdata/mariadb/config:/config
    ports:
      - "$MARIADB_PORT:3306"
