########################### NETWORKS
networks:
  default:
    driver: bridge
  socket_proxy:
    name: socket_proxy
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.14.0/24
  t3_proxy:
    name: t3_proxy
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.15.0/24
    external: true

########################### SECRETS
secrets:
  plex_claim:
    file: $DOCKERDIR/secrets/plex_claim

services:

  # Docker Socket Proxy - Security Enchanced Proxy for Docker Socket
  socket-proxy:
    container_name: socket-proxy
    image: linuxserver/socket-proxy:3.2.5-r0-ls56@sha256:1be5bc2319d84e94999ad8461aa5864dae245d63247779bbd5630ba7151b30b7
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    profiles: ["core", "all"]
    networks:
      socket_proxy:
        ipv4_address: 192.168.14.254 # You can specify a static IP
    privileged: true # true for VM. False (default) for unprivileged LXC container.
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    read_only: true
    tmpfs:
      - /run
    environment:
      - LOG_LEVEL=warning # debug,info,notice,warning,err,crit,alert,emerg
      - ALLOW_START=1 # Portainer
      - ALLOW_STOP=1 # Portainer
      - ALLOW_RESTARTS=1 # Portainer
      ## Granted by Default
      - EVENTS=1
      - PING=1
      - VERSION=1
      ## Revoked by Default
      # Security critical
      - AUTH=0
      - SECRETS=0
      - POST=1 # Watchtower
      # Not always needed
      - BUILD=0 - COMMIT=0 - CONFIGS=0 - CONTAINERS=1 # Traefik, portainer, etc. - DISTRIBUTION=0 - EXEC=0 - 
      - IMAGES=1 # Portainer - INFO=1 # Portainer - NETWORKS=1 # Portainer - NODES=0 - PLUGINS=0 - SERVICES=1 # 
      - Portainer - SESSION=0 - SWARM=0 - SYSTEM=0 - TASKS=1 # Portainer - VOLUMES=1 # Portainer - 
      - DISABLE_IPV6=0 #optional

  agent:
    container_name: portainer_agent
    image: portainer/agent:2.34.0@sha256:ffe66edf605824d0249e19ade394d7b764209b002b60b5cebd959c81c2c6fbb2
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    profiles: ["core", "all"]
    networks:
      - default
      - socket_proxy
    ports:
      - $PORTAINER_AGENT_PORT:9001     # Agent API
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro # Use Docker Socket Proxy instead for improved security
      - /var/lib/docker/volumes:/var/lib/docker/volumes
      - /:/host

  dozzle-agent:
    container_name: dozzle_agent
    image: amir20/dozzle:v8.14.4@sha256:e944224b30d0ac8771d7e54c5ae0dfb30859d6b7e590b65e90bafe39c15c46ce
    restart: always
    command: agent
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
      - $DOZZLE_AGENT_PORT:7007


  ###### DOWNLOADERS

  # TransmissionBT - Torrent Downloader
  # ONLY ACCESSIBLE THROUGH https://domain.com/transmission/web/ if using PathPrefix
  # For Proxmox LXC Containers - https://pve.proxmox.com/wiki/OpenVPN_in_LXC
  transmission-vpn:
    container_name: transmission-vpn
    image: haugene/transmission-openvpn:5.3.1@sha256:a128b49e29379895c5815e8bea3c1b5eb42ccbef4ab9e5109a72b97d8fd7c0b0
    restart: always
    networks:
      t3_proxy:
        ipv4_address: 192.168.15.169
      socket_proxy:
    ports:
      - $TRANSMISSION_PORT:9091
    cap_add:
      - NET_ADMIN
    devices:
      # Explicitly pass the TUN device from the LXC to the Docker container
      - /dev/net/tun:/dev/net/tun
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - $DOCKERDIR/appdata/transmission-vpn/data:/data
      - $DOCKERDIR/appdata/transmission-vpn/config:/config
      - $DATADIR/downloads:/data/downloads
    environment:
      - PUID=$PUID
      - PGID=$PGID
      - TZ=$TZ
      - OPENVPN_PROVIDER=WINDSCRIBE
      - OPENVPN_USERNAME=$OPENVPN_USERNAME
      - OPENVPN_PASSWORD=$OPENVPN_PASSWORD
      - OPENVPN_CONFIG=Amsterdam-Tulip-tcp,Brussels-Guildhouse-tcp,Frankfurt-Wiener-tcp
      - OPENVPN_OPTS=--inactive 3600 --ping 10 --ping-exit 60
      - LOCAL_NETWORK=192.168.5.0/24
#      LOCAL_NETWORK: "$LOCAL_NETWORK"
      - UMASK_SET=2
      - TRANSMISSION_RPC_AUTHENTICATION_REQUIRED="false"
      - TRANSMISSION_RPC_HOST_WHITELIST="127.0.0.1,$SERVER_IP"
      - TRANSMISSION_RPC_PASSWORD=$TRANSMISSION_RPC_PASSWORD
      - TRANSMISSION_RPC_USERNAME=$TRANSMISSION_RPC_USERNAME
      - TRANSMISSION_UMASK=002
      - TRANSMISSION_RATIO_LIMIT="0.0099"
      - TRANSMISSION_RATIO_LIMIT_ENABLED="true"
      - TRANSMISSION_ALT_SPEED_DOWN=40000
      - TRANSMISSION_ALT_SPEED_ENABLED="false"
      - TRANSMISSION_ALT_SPEED_UP=250
      - TRANSMISSION_SPEED_LIMIT_DOWN=80000
      - TRANSMISSION_SPEED_LIMIT_DOWN_ENABLED="true"
      - TRANSMISSION_SPEED_LIMIT_UP=500
      - TRANSMISSION_SPEED_LIMIT_UP_ENABLED="true"
      - TRANSMISSION_INCOMPLETE_DIR=/data/downloads/incomplete
      - TRANSMISSION_INCOMPLETE_DIR_ENABLED="true"
      - TRANSMISSION_WATCH_DIR=/data/downloads
      - TRANSMISSION_WATCH_DIR_ENABLED="true"
      - TRANSMISSION_DOWNLOAD_DIR=/data/downloads
#      LOG_TO_STDOUT: "true"
      - DISABLE_PORT_UPDATER="true"
      - CREATE_TUN_DEVICE="false"
#      TRANSMISSION_WEB_HOME: '/'
    labels:
      - "traefik.enable=true"

  # Jackett
  jackett:
    container_name: jackett
    image: linuxserver/jackett:0.24.87@sha256:87e2f1de955de8426c80a4cd74631f244b544bee739de606870472ff686baa8c
    networks:
      t3_proxy:
        ipv4_address: 192.168.15.170
    ports:
      - $JACKETT_PORT:9117
    depends_on:
      - transmission-vpn
    #network_mode: container:transmission-openvpn
    #security_opt:
    #  - no-new-privileges:true
    volumes:
      - $DOCKERDIR/appdata/jackett:/config
      - $DATADIR/downloads:/downloads
      - /etc/localtime:/etc/localtime:ro
      - $DOCKERDIR/shared:/shared
    environment:
      - PUID=$PUID
      - PGID=$PGID
      - TZ=$TZ
    labels:
      - "traefik.enable=true"
