name: deploy grogu-ms stack

on:
  push:
    branches:
      - main
  workflow_dispatch:   # this enables the "Run workflow" button in GitHub

jobs:
  deploy:
    runs-on: [self-hosted, ms]
    defaults:
      run:
        working-directory: /home/medivh/docker
    steps:    
      - name: Sync repo into /home/medivh/docker
        run: |
          if [ ! -d "/home/medivh/docker/.git" ]; then
            echo "Repo not found in /home/medivh/docker (grogu-ms), cloning fresh..."
            git clone https://x-access-token:${{ secrets.GH_PAT }}@github.com/esculato/Grogu.git /home/medivh/docker
          else
            echo "Repo exists (grogu-ms), updating..."
            cd /home/medivh/docker
            git fetch origin main
            git reset --hard origin/main
          fi
          
      - name: Check docker-compose file exists
        run: |
          if [ ! -f "docker-compose-ms.yml" ]; then
            echo "ERROR: docker-compose-ms.yml not found in /home/medivh/docker (grogu-ms)"
            exit 1
          fi
          echo "docker-compose-ms.yml found. (grogu-ms)"

      - name: Redeploy stack
        run: |
          echo "Pulling latest images... (grogu-ms)"
          docker compose -f docker-compose-ms.yml pull
          echo "Restarting containers... (grogu-ms)"
          docker compose -f docker-compose-ms.yml up -d
          echo "Deployment completed successfully. (grogu-ms)"
