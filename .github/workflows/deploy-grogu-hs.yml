name: deploy grogu-hs stack

on:
  push:
    branches:
      - main
  workflow_dispatch:   # this enables the "Run workflow" button in GitHub

jobs:
  deploy:
    runs-on: [self-hosted, grogu-hs]
    defaults:
      run:
        working-directory: /home/medivh/docker
    steps:    
      - name: Sync repo into /home/medivh/docker
        run: |
          if [ ! -d "/home/medivh/docker/.git" ]; then
            echo "Repo not found in /home/medivh/docker (grogu-hs), cloning fresh..."
            git clone https://x-access-token:${{ secrets.GH_PAT }}@github.com/esculato/Grogu.git /home/medivh/docker
          else
            echo "Repo exists (grogu-hs), updating..."
            cd /home/medivh/docker
            git fetch origin main
            git reset --hard origin/main
          fi
          
      - name: Check docker-compose file exists
        run: |
          if [ ! -f "docker-compose-hs.yml" ]; then
            echo "ERROR: docker-compose-hs.yml not found in /home/medivh/docker (grogu-hs)"
            exit 1
          fi
          echo "docker-compose-hs.yml found. (grogu-hs)"

      - name: Redeploy stack
        run: |
          echo "Pulling latest images... (grogu-hs)"
          docker compose -f docker-compose-hs.yml pull
          echo "Restarting containers... (grogu-hs)"
          docker compose -f docker-compose-hs.yml up -d
          echo "Deployment completed successfully. (grogu-hs)"
